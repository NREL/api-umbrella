include <%= latest_release %>/config/nginx/ssl_terminator.conf;
include <%= latest_release %>/config/nginx/backends/*.conf;

log_format api_umbrella_log '"$x_api_umbrella_uid","$router_name","$time_iso8601","$msec","$request_time","$upstream_response_time","$request_length","$bytes_sent","$status","$remote_addr","$request_method","$scheme","$http_host","$server_port","$request_uri","$http_user_agent"';

# Limit the number of simultaneous connections per IP address.
limit_conn_zone $binary_remote_addr zone=api_umbrella_conn_addr_zone:5m;
limit_conn_status 429;

# Rate limits per IP address.
#
# In general, we want to rely on the more granular and configurable rate limits
# provided by the API Umbrella Gatekeeper, so this limit should be higher than
# the Gatekeeper's limits. This just provides an extra line of simple defense
# against misbehaving clients from overloading the Gatekeeper.
limit_req_zone $binary_remote_addr zone=api_umbrella_req_addr_zone:5m rate=100r/s;
limit_req_status 429;

server {
  listen 80;
  server_name <%= all_domains.join(" ") %>;

  access_log <%= current_path %>/log/access.log combined;
  error_log <%= current_path %>/log/error.log;

  # Limit the number of simulaneous connections per IP address to 50.
  limit_conn api_umbrella_conn_addr_zone 50;

  # After the 100 requests/second rate is reached, allow a sizable burst before
  # completely terminating requests at this router level. This is so we can
  # generally rely on API Umbrella Gatekeeper for rate limiting, but still
  # throttle traffic to the Gatekeeper.
  limit_req zone=api_umbrella_req_addr_zone burst=100 nodelay;

  keepalive_timeout 30s;

  # Proxy over HTTP 1.1 so keepalive connections to the backend are supported.
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  # Default proxy headers.
  proxy_set_header Host $http_host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  # Conditional proxy headers. Don't set these x-forwarded headers if they've
  # already been set (by the SSL terminator).
  set $real_scheme $http_x_forwarded_proto;
  if ($real_scheme = "") {
    set $real_scheme $scheme; 
  }

  set $real_port $http_x_forwarded_port;
  if ($real_port = "") {
    set $real_port $server_port; 
  }

  proxy_set_header X-Forwarded-Proto $real_scheme;
  proxy_set_header X-Forwarded-Port $real_port;

  location ~* ^/(about|community|doc|docs|images|static|)(/|$) {
    rewrite ^/doc(/|$) /docs/ permanent;

    proxy_set_header Host "api.data.gov";
    proxy_pass http://github_pages_backend;
  }

  location ~* ^/(account|admin|admins|assets|contact|favicon\.ico|javascripts|robots.txt|signup)(/|$) {
    proxy_pass http://api_umbrella_web_backend;
  }

  location / {
    set $x_api_umbrella_uid $request_id;
    set $router_name "web_router";
    access_log <%= current_path %>/log/router.log api_umbrella_log;

    proxy_set_header X-Api-Umbrella-UID $request_id;
    proxy_pass http://api_umbrella_gatekeeper_backend;
  }
}

server {
  listen 50100;

  access_log <%= current_path %>/log/access.log combined;
  error_log <%= current_path %>/log/error.log;

  set $x_api_umbrella_uid $http_x_api_umbrella_uid;
  set $router_name "api_router";
  access_log <%= current_path %>/log/router.log api_umbrella_log;

  keepalive_timeout 5m;

  # Remove the legacy /api/ prefix from all API urls. Now we assume API URLs
  # are all top-level.
  rewrite ^/api(/.*) $1 break;

  location ~* ^/api-users/ {
    # Re-add the /api prefix for this web backend.
    rewrite ^(/api-users/.*) /api$1 break;

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_set_header Host $http_host;
    proxy_pass http://api_umbrella_web_backend;
  }

  location ~* ^/bjs/ {
    rewrite ^/bjs(/.*) $1 break;
    proxy_set_header Host "bjs.gov:8080";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://bjs_apis_backend;
  }

  location ~* ^/fcc/ {
    rewrite ^/fcc(/.*) $1 break;
    proxy_set_header Host "broadbandmap.gov";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://broadbandmap_apis_backend;
  }

  location ~* ^/census/ {
    # Initial examples.
    set $old_state "*";
    if ($uri ~ "/states/[A-Z][A-Z]") {
      set $old_state $path_state_number;
    }

    rewrite ^/census/american-community-survey/v1/([0-9][0-9][0-9][0-9])/populations/states /data/$1/acs5?key=e81ad00727f0e08a8fd615d9db0e2d148ff44f77&get=B02001_001E,NAME&for=state:$old_state? break;

    # Newer examples with geo scoping.
    set $in "";
    set $state "*";
    set $county "*";
    set $tract "*";
    set $blockgroup "*";

    if ($arg_state) {
      set $state $state_number;
    }

    if ($arg_county) {
      set $county $arg_county;
    }

    if ($arg_tract) {
      set $tract $arg_tract;
    }

    if ($arg_blockgroup) {
      set $blockgroup $arg_blockgroup;
    }

    set $county_in_filters "state:$state";
    set $tract_in_filters "state:$state+county:$county";
    set $blockgroup_in_filters "state:$state+county:$county+tract:$tract";

    rewrite ^/census/acs/v1/[0-9][0-9][0-9][0-9]-([0-9][0-9][0-9][0-9])/pop/states/?$ /data/$1/acs5?key=e81ad00727f0e08a8fd615d9db0e2d148ff44f77&get=B02001_001E,NAME&for=state:$state? break;
    rewrite ^/census/acs/v1/[0-9][0-9][0-9][0-9]-([0-9][0-9][0-9][0-9])/pop/counties/?$ /data/$1/acs5?key=e81ad00727f0e08a8fd615d9db0e2d148ff44f77&get=B02001_001E,NAME&for=county:$county&in=$county_in_filters? break;
    rewrite ^/census/acs/v1/[0-9][0-9][0-9][0-9]-([0-9][0-9][0-9][0-9])/pop/tracts/?$ /data/$1/acs5?key=e81ad00727f0e08a8fd615d9db0e2d148ff44f77&get=B02001_001E,NAME&for=tract:$tract&in=$tract_in_filters? break;
    rewrite ^/census/acs/v1/[0-9][0-9][0-9][0-9]-([0-9][0-9][0-9][0-9])/pop/blockgroups/?$ /data/$1/acs5?key=e81ad00727f0e08a8fd615d9db0e2d148ff44f77&get=B02001_001E,NAME&for=block+group:$blockgroup&in=$blockgroup_in_filters? break;

    proxy_set_header Host "api.census.gov";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://census_apis_backend;
  }

  location ~* ^/dol/ {
    rewrite ^/dol(/.*) $1?KEY=9f54ed13-2052-4764-b26a-0232e0f50247 break;
    proxy_set_header Host "api.dol.gov";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://dol_apis_backend;
  }

  location ~* ^/myusa/ {
    rewrite ^/myusa/discovery(/.*) $1 break;
    proxy_set_header Host "discovery.my.usa.gov";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://myusa_discovery_apis_backend;
  }

  location ~* ^/nrel/ {
    rewrite ^/nrel(/.*) /api$1?api_key=bcc50c5b78ad7fe4109dffad2bcc1b8d28f724c6 break;
    proxy_set_header Host "developer.nrel.gov";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://nrel_apis_backend;
  }

  location ~* ^/regulations/ {
    rewrite ^/regulations(/.*) /api$1?api_key=366308fd-0a86-4590-940a-be1cd050f4e9 break;
    proxy_set_header Host "www.regulations.gov";

    # Enable keep alive connections to the backend servers.
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_pass http://regulations_apis_backend;
  }
}

# For the Census APIs.
map $arg_state $state_number {
  AL 01;
  AK 02;
  AZ 04;
  AR 05;
  CA 06;
  CO 08;
  CT 09;
  DE 10;
  DC 11;
  FL 12;
  GA 13;
  HI 15;
  ID 16;
  IL 17;
  IN 18;
  IA 19;
  KS 20;
  KY 21;
  LA 22;
  ME 23;
  MD 24;
  MA 25;
  MI 26;
  MN 27;
  MS 28;
  MO 29;
  MT 30;
  NE 31;
  NV 32;
  NH 33;
  NJ 34;
  NM 35;
  NY 36;
  NC 37;
  ND 38;
  OH 39;
  OK 40;
  OR 41;
  PA 42;
  RI 44;
  SC 45;
  SD 46;
  TN 47;
  TX 48;
  UT 49;
  VT 50;
  VA 51;
  WA 53;
  WV 54;
  WI 55;
  WY 56;
}

map $uri $path_state_number {
  "~/states/AL" 01;
  "~/states/AK" 02;
  "~/states/AZ" 04;
  "~/states/AR" 05;
  "~/states/CA" 06;
  "~/states/CO" 08;
  "~/states/CT" 09;
  "~/states/DE" 10;
  "~/states/DC" 11;
  "~/states/FL" 12;
  "~/states/GA" 13;
  "~/states/HI" 15;
  "~/states/ID" 16;
  "~/states/IL" 17;
  "~/states/IN" 18;
  "~/states/IA" 19;
  "~/states/KS" 20;
  "~/states/KY" 21;
  "~/states/LA" 22;
  "~/states/ME" 23;
  "~/states/MD" 24;
  "~/states/MA" 25;
  "~/states/MI" 26;
  "~/states/MN" 27;
  "~/states/MS" 28;
  "~/states/MO" 29;
  "~/states/MT" 30;
  "~/states/NE" 31;
  "~/states/NV" 32;
  "~/states/NH" 33;
  "~/states/NJ" 34;
  "~/states/NM" 35;
  "~/states/NY" 36;
  "~/states/NC" 37;
  "~/states/ND" 38;
  "~/states/OH" 39;
  "~/states/OK" 40;
  "~/states/OR" 41;
  "~/states/PA" 42;
  "~/states/RI" 44;
  "~/states/SC" 45;
  "~/states/SD" 46;
  "~/states/TN" 47;
  "~/states/TX" 48;
  "~/states/UT" 49;
  "~/states/VT" 50;
  "~/states/VA" 51;
  "~/states/WA" 53;
  "~/states/WV" 54;
  "~/states/WI" 55;
  "~/states/WY" 56;
}

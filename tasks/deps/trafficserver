#!/usr/bin/env bash

trafficserver_version="10.1.0"
trafficserver_hash="836cac33f6a54be2b62eaa881b333d16a6029177f3ce788fce3eec7d097843bbbd49bb9a748d6ec6592d86e6d425975f6a9b462401ab808e1e4f0726488eb2b8"

set -e -u -x
source ./tasks/helpers.sh
source ./tasks/helpers/detect_os_release.sh

task_working_dir
download "https://archive.apache.org/dist/trafficserver/trafficserver-$trafficserver_version.tar.bz2" "sha512" "$trafficserver_hash"
extract_download "trafficserver-$trafficserver_version.tar.bz2"

cd "trafficserver-$trafficserver_version"

cmake -B build \
  -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX_EMBEDDED" \
  -DENABLE_LUAJIT=ON \
  -Dluajit_INCLUDE_DIRS="$STAGE_EMBEDDED_DIR/openresty/luajit/include/luajit-2.1" \
  -Dluajit_LIBRARY_DIRS="$STAGE_EMBEDDED_DIR/openresty/luajit/lib" \
  -Dluajit_LIBRARIES=luajit-5.1 \
  -Dluajit_LINK_LIBRARIES=luajit-5.1 \
  -DENABLE_JEMALLOC=ON

cmake --build build -j "$NPROC"

cmake --install build --prefix="$STAGE_EMBEDDED_DIR"

chrpath -d "$STAGE_EMBEDDED_DIR/lib/libswoc.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtsapi.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtscppapi.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libyaml-cpp.so"
find "$STAGE_EMBEDDED_DIR/libexec/trafficserver/" -name "*.so" -exec chrpath -d {} \;
find "$STAGE_EMBEDDED_DIR/bin/" -name "traffic_*" -exec chrpath -d {} \;

stamp

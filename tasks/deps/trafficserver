#!/usr/bin/env bash

# Hold at 9.1.x until we can figure out this issue currently present in 9.2.2:
# https://github.com/apache/trafficserver/issues/10393 This issue has been
# reproducible by running the following test in a loop:
# bundle exec minitest test/apis/test_web_app_large_body.rb -n test_limit_is_configurable
trafficserver_version="10.0.2"
trafficserver_hash="5de65130d4c0997d619d0c1be6840aaffd3e17abd820d22b9294c4d78834eb71a58fed12f3166396c7169583850a8b42ed768e5af11e855c87b2fca8a10da7f3"

set -e -u -x
source ./tasks/helpers.sh
source ./tasks/helpers/detect_os_release.sh

task_working_dir
download "https://archive.apache.org/dist/trafficserver/trafficserver-$trafficserver_version.tar.bz2" "sha512" "$trafficserver_hash"
extract_download "trafficserver-$trafficserver_version.tar.bz2"

cd "trafficserver-$trafficserver_version"

PKG_CONFIG_PATH="$STAGE_EMBEDDED_DIR/openresty/luajit/lib/pkgconfig:${PKG_CONFIG_PATH:-}" \
cmake -B build \
  -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX_EMBEDDED" \
  -DENABLE_LUAJIT=ON \
  -DENABLE_JEMALLOC=ON

cmake --build build -j "$NPROC"

cmake --install build

chrpath -d "$STAGE_EMBEDDED_DIR/lib/libswoc"*.so
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtsapi.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtscppapi.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libyaml-cpp.so"
find "$STAGE_EMBEDDED_DIR/libexec/trafficserver/" -name "*.so" -exec chrpath -d {} \;
find "$STAGE_EMBEDDED_DIR/bin/" -name "traffic_*" -exec chrpath -d {} \;

stamp

#!/usr/bin/env bash

set -e -u -x
source ./tasks/helpers.sh

envoy_version="1.36.2"
envoy_hash="afd67bcfea548525ee76a9350a0a4cfeb2ac24c7b532794ce332d840ad8cdae7"

download_arch="$TARGETARCH"
if [ "$TARGETARCH" == "amd64" ]; then
  download_arch="x86_64"
elif [ "$TARGETARCH" == "arm64" ]; then
  download_arch="aarch_64"
  envoy_hash="af736bb6653cce9c52b2f3b092a3602ac21a60ac675698d060dc4d82837c05ca"
fi

task_working_dir
download "https://github.com/envoyproxy/envoy/releases/download/v${envoy_version}/envoy-${envoy_version}-linux-${download_arch}" "sha256" "$envoy_hash"

install -D -m 755 "_persist/downloads/envoy-${envoy_version}-linux-${download_arch}" "$STAGE_EMBEDDED_DIR/bin/envoy"
chrpath -d "$STAGE_EMBEDDED_DIR/bin/envoy"

stamp

#!/usr/bin/env bash

set -e -u -x
source ./tasks/helpers.sh

envoy_version="1.34.3"
envoy_hash="d38bc6811f14d2a88d06f9a28a6d1a29ae9483669c477d45e47e1b8925a4ada8"

download_arch="$TARGETARCH"
if [ "$TARGETARCH" == "amd64" ]; then
  download_arch="x86_64"
elif [ "$TARGETARCH" == "arm64" ]; then
  download_arch="aarch_64"
  envoy_hash="2ec364ac5279f4c5222881740dcbaad8b867dcb9c05b4330971e24231efc29f4"
fi

task_working_dir
download "https://github.com/envoyproxy/envoy/releases/download/v${envoy_version}/envoy-${envoy_version}-linux-${download_arch}" "sha256" "$envoy_hash"

install -D -m 755 "_persist/downloads/envoy-${envoy_version}-linux-${download_arch}" "$STAGE_EMBEDDED_DIR/bin/envoy"
chrpath -d "$STAGE_EMBEDDED_DIR/bin/envoy"

stamp

#!/usr/bin/env bash

set -e -u -x
source ./tasks/helpers.sh

envoy_version="1.36.4"
envoy_hash="5a398095d8c1dd363ecc10b6b9dbd82154a8fbb5eb15510d5fb7cbdb9d0b0e59"

download_arch="$TARGETARCH"
if [ "$TARGETARCH" == "amd64" ]; then
  download_arch="x86_64"
elif [ "$TARGETARCH" == "arm64" ]; then
  download_arch="aarch_64"
  envoy_hash="45551e3ba31b2368fb80cf4c124b21857c54e0e81aee3b708ebd7b0ba3f755b1"
fi

task_working_dir
download "https://github.com/envoyproxy/envoy/releases/download/v${envoy_version}/envoy-${envoy_version}-linux-${download_arch}" "sha256" "$envoy_hash"

install -D -m 755 "_persist/downloads/envoy-${envoy_version}-linux-${download_arch}" "$STAGE_EMBEDDED_DIR/bin/envoy"
chrpath -d "$STAGE_EMBEDDED_DIR/bin/envoy"

stamp
